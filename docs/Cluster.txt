集群中坐席状态与控制逻辑
版本：V1.1
一、环境
二、名词
1.坐席客户端
2.IPSC服务端节点
3.坐席客户端连接主从标识：坐席客户端登录和注销动作内容里，包含连接主从标识
4.坐席客户端主连接：坐席客户端与IPSC服务端的连接，坐席客户端除登录后的动作均发送给该主连接。
5.坐席客户端从连接：坐席客户端与IPSC服务端的连接，坐席客户端只做连接和登录动作，其他动作不发送给该从连接。
坐席将主连接设置为从连接时，如果连接可用，则向该连接的IPSC服务端发送从连接标识消息（无条件发送）。
6.坐席客户端连接可用标识：由IPSC服务端发送节点是否可用消息来标识的。
三、坐席客户端逻辑
1.坐席客户端主连接选择规则
a)坐席初创连接时
在客户端连接池里面随机（或者无序）选择一个可用连接作为主连接，其他连接作为从连接。
b)坐席收到工作状态消息（振铃、工作）
将工作的这个连接设置为主连接。
c)主连接断开时
坐席为非工作状态时：坐席客户端选择另一个可用连接设置为主连接，这个连接改为从连接，同时尝试重连这个连接。
坐席为工作状态时（振铃、工作）：坐席保持这个连接为主连接，同时尝试重连这个连接。
d)主连接断开又恢复连接时
坐席保持现有的主连接标识，不做主从标记切换。
e)下述其他内容里的设置规则
2.收到IPSC服务端主动注销消息
坐席客户端将其他连接设置为从连接，然后向其他连接发送注销动作。
3.坐席客户端主动注销
坐席客户端需至少保证有一个连接正常的主连接。
然后坐席向所有连接发送注销动作。
4.含目标坐席的坐席动作（拦截、监听、强插、强拆等）
获取到工作中（振铃、工作）目标坐席所在的节点，将本坐席该节点连接设为主连接，其他节点设为从连接。
向新设的主连接发送动作。
5.含目标通道的坐席动作（空闲状态下的抢接）
获取到目标通道所在的节点，将本坐席该节点连接设为主连接，其他节点设为从连接。
向新设的主连接发送动作。
6.保持动作和消息
工作状态下抢接：设置待保持的通话为从连接；获取抢接目标通道所在节点，将本作下该节点连接设置为主连接。
切换保持会话：将找回的保持会话的连接设置为主连接；当前会话切换为保持会话，此时会收到IPSC发过来的保持消息，如果该保持的连接和刚找回的会话连接不是同一个时，则将该保持的连接设置为从连接。
其他情况下的保持动作和消息：不做主从切换。
7.其他坐席动作
均向主连接发送动作。
四、IPSC服务端逻辑
1.坐席客户端连接并登录时，IPSC识别登录消息里的连接主从标识，如果标识为：
主连接标识：更新集群状态，执行标准坐席服务端逻辑；向坐席发送坐席状态和数据。
从连接标识：不更新集群状态；不向坐席发送坐席状态和数据消息。
2.接收到坐席客户端注销动作，IPSC识别注销消息里的连接主从标识，如果标识为：
主连接标识：更新集群状态，执行标准坐席服务端逻辑； 
从连接标识：不更新集群状态，执行标准坐席服务端逻辑；
3.接收到坐席客户端登录后的其他动作（除注销动作）
动作前的当前连接主从标识为：
主连接标识：更新集群状态，执行标准坐席服务端逻辑（含状态逻辑检查）；向坐席发送坐席状态和数据。
从连接件标识：更新集群状态，执行标准坐席服务端逻辑（不含状态逻辑检查）；向坐席发送坐席状态和数据；设置当前连接为主连接。
4.服务器主动注销坐席

5.接收到坐席从连接标识
将当前标识设置为从连接。
6.排队
IPSC依据集群数据进行全局坐席排队；设置排到的坐席连接标识为主连接。
五、其他资源故障时
1.无可用PBX资源，或PBX内部无可用资源时（由IPSC判断）
无可用资源条件：无可用PBX、无可用外线通道（中继、SIP、FXO）、其他待定。
IPSC服务端向坐席客户端发送节点不可用消息，坐席客户端将该节点连接设置为不可用。
2.PBX资源恢复时
IPSC服务端向坐席客户端发送节点可用消息，坐席客户端将该节点连接设置为可用。
3.待补充
六、变更的坐席消息
1.坐席登录动作：登录内容nParam为主从标识，1 是主、0 是从
2.坐席注销动作：注销内容的 nParam为主从标识，1 是主、0是从
3.增加从连接通知动作：坐席客户端发起从连接通知消息，msgtype=38（修改连接标识），nParam=0
4.增加服务端节点可用消息：服务端用SendAgentData()发送，DataType=14（IPSC节点可用标记），nParam定义：0 IPSC服务节点不可用、1 服务节点可用
